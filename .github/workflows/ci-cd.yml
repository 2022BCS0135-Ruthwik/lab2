name: CI-CD Pipeline

on: [push]

jobs:
  train:
    runs-on: ubuntu-latest
    outputs:
      mse: ${{ steps.metrics.outputs.mse }}
      r2: ${{ steps.metrics.outputs.r2 }}

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - run: pip install -r requirements.txt

    - run: python scripts/train.py

    - name: Read metrics
      id: metrics
      run: |
        MSE=$(jq .MSE outputs/metrics.json)
        R2=$(jq .R2 outputs/metrics.json)
        echo "mse=$MSE" >> $GITHUB_OUTPUT
        echo "r2=$R2" >> $GITHUB_OUTPUT

    - uses: actions/upload-artifact@v4
      with:
        name: model-artifacts
        path: outputs/

  deploy:
    needs: train
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/download-artifact@v4
      with:
        name: model-artifacts
        path: outputs/

    - name: Compare metrics
      run: |
        if (( $(echo "${{ needs.train.outputs.r2 }} <= ${{ vars.BEST_R2 }}" | bc -l) )); then
          echo "2022BCS0135 ---- Metric did not improve"
          exit 0
        fi

    - uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - run: |
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/wine_predict_2022BCS0135:latest .
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/wine_predict_2022BCS0135:latest
